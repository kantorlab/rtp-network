---
title: 'Table `1`: Descriptives of Index and Partner Cases'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

### Objective 

The purpose here is to create a prototype of Table 1 - summarizing demographic
and behavioral characteristics of index persons and their contacts.



```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE,
                      root.dir = '~/code/rtp-network/out/')

library(data.table)
library(dplyr)
library(stringi)
library(network)
```



```{r read_data, include=FALSE}
data_dir <- "/gpfs/data/rkantor/rtp/datasets/D30_20211013_V1"
list.files(path=data_dir)
net_dt <- as.data.table(read.csv(paste0(data_dir, "/ContactTracingNetwork.csv")))
individuals_dt <- as.data.table(read.csv(paste0(data_dir, "/Individuals.csv")))


```

### Structure of the Individual Database 

How many unique persons in the individuals database?

```{r}

head(individuals_dt)

nrow(individuals_dt)
length(unique(individuals_dt$StudyID))

table(substr(individuals_dt$StudyID, 1, 3))
```
**Note**: There are no persons with "CONTACT" Study ID in the individuals
database. 

What is the source of the information of persons in the individuals database?

```{r}
table(individuals_dt$Source, exclude = NULL)
table(individuals_dt$Source, exclude = NULL)/sum(table(individuals_dt$Source, exclude = NULL))
```

```{r}
colnames(individuals_dt)
#matrix(cbind(1:ncol(individuals_dt), colnames(individuals_dt)), nrow=22, ncol=4)
```

```{r}
individuals_dt[Source=="RIDOH", .SD, .SDcols=c(1:34)]
lapply(individuals_dt, summary)

summarize_cols <- function(x){
  if(is.numeric(x)) {
    summary(x)
    } else if (!is.numeric(x)) { 
      table(x)
    }
}

#lapply(individuals_dt, summarize_cols)
```

```{r}
summary(individuals_dt$HIVDxAge)

individuals_dt[, summary(.SD), .SDcols = "HIVDxAge"]

individuals_dt[Source=="ICDB", summary(.SD), .SDcols = "HIVDxAge"]
individuals_dt[Source=="RIDOH", summary(.SD), .SDcols = "HIVDxAge"]
```

```{r}
individuals_dt[, table(.SD), .SDcols = "Outcome"]
```

## Structure of the Partner Database

```{r}
dim(net_dt)
```

The partner data are 4070 observations and 24 variables.


What is the structure of the StudyIDFrom and StudyIDTo columns in the 
partner database?

The first column is “StudyIDFrom” - persons who are interviewed to obtain partner information. This column includes persons who are recruited because they are reported on by an index person. This column is distributed as: persons who come from ICDB (assigned S numbers, n=1841); who come from the RIDOH database (assigned RIDOH numbers, n= 356), and Contacts (n=1873).

```{r, studyidfrom}
head(net_dt)

nrow(net_dt)
length(unique(net_dt$StudyIDFrom))

table(substr(net_dt$StudyIDFrom, 1, 3), exclude = NULL)

table(substr(net_dt$StudyIDFrom, 1, 1), exclude = NULL)

#table(substr(net_dt$StudyIDFrom, 1, 3), exclude = NULL)[["CON"]] + length(unique(net_dt$StudyIDFrom))
```
What is the structure of the persons (i.e., "STUDYIDTos") that the StudyIDFrom's 
are reporting on?


```{r, studyidto}
nrow(net_dt)
length(unique(net_dt$StudyIDTo))

table(substr(net_dt$StudyIDTo, 1, 1), exclude = NULL)
```

Distribution of "StudyIDTos" reported by S persons, RIDOH persons, and contacts:

```{r}
# Reported by S persons
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "S")]$StudyIDTo, 1, 1), exclude = NULL)

# Reported by R persons
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "R")]$StudyIDTo, 1, 1), exclude = NULL)

# Reported by Contacts
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "C")]$StudyIDTo, 1, 1), exclude = NULL)
```

Characterize the other variables appearing the partner dataset:

### Interview Characteristics

```{r}
table(stri_sub(net_dt$InterviewID, -1, -1), exclude = NULL)
table(net_dt$InterviewRank, exclude = NULL)
table(stri_sub(net_dt$InterviewRank, -1, -1), exclude = NULL)
table(net_dt$InterviewType, exclude = NULL)

idx_client_newdiag_dt <- net_dt[InterviewType == "Index Client - New diagnosis"]
idx_client_highvl_dt <- net_dt[InterviewType == "Index Client - In care, high viral load"]
```

### Referral/Reporting Characteristics of Index Persons

```{r}
reported_true_dt <- net_dt[which(Reported == "True"),,]
not_reported_dt <- net_dt[which(Reported == ""),,]

reported_true_dt$IndexHIVTestDate
nohivtestdt_among_reported_idx <- which(reported_true_dt$IndexHIVTestDate == "")
reported_true_dt[nohivtestdt_among_reported_idx,]

table(substr(reported_true_dt[nohivtestdt_among_reported_idx,]$StudyIDFrom, 1, 1), 
      exclude = NULL)


```


### Characteristics of reported partner contacts

```{r}
table(net_dt$IdentifiedDate, exclude = NULL)
table(net_dt$IdentifiedRisk, exclude = NULL)
table(net_dt$Notify, exclude = NULL)
table(net_dt$NotifyWho, exclude = NULL)
table(net_dt$NotifyMethod, exclude = NULL)
table(net_dt$AlreadyIndexCase, exclude = NULL)
table(net_dt$ClientReached, exclude = NULL)
table(net_dt$ClientNotReached, exclude = NULL)
length(which(net_dt$PartnerServicesOfferedDate != ""))
#View(net_dt[which(net_dt$PartnerServicesOfferedDate != ""),,])
net_dt[which(net_dt$PartnerServicesOfferedDate!=""), .N,
       by="PartnerServicesAccepted"][]
```


### Analyze the individuals who are intervewed in the partner dataset
How many of the `r length(unique(individuals_dt$StudyID))` individuals appear 
in the partner database, as ``StudyIDFrom'' or ``StudyIDTo''?

```{r}
individuals_in_net_dt_studyidfrom <- which(individuals_dt$StudyID %in% net_dt$StudyIDFrom)
length(individuals_in_net_dt_studyidfrom)

individuals_in_net_dt_studyidto <- which(individuals_dt$StudyID %in% net_dt$StudyIDTo)
length(individuals_in_net_dt_studyidto)
```

There are `r length(individuals_in_net_dt_studyidfrom)` unique individuals in the
StudyIDFrom column in the partner contact database. 

### Describe the demographic and behavioral characteristics of the index persons 
This would include individuals who are also in the partner database (n = `r length(individuals_in_net_dt_studyidfrom)`)

#### By source

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(n_source=.N), 
               by=.(Source)
               ][,
                 "prop":=round(n_source/sum(n_source), 3)
                 ][
                 ]
```

#### Gender and Birth Sex

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoGender)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoBirthSex)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]
```

#### Race and Ethnicity

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoRace)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoHispanic)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoRace, DemoHispanic)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ][order(DemoRace)]
```

#### Year of HIV Diagnosis 

```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(hiv_diag_year=substr(HIVDxDate, 1, 4))
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hiv_diag_year)
                 ]
```
#### Age of HIV Diagnosis

```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, 
               .(mean=mean(HIVDxAge, na.rm=T), 
                 median=median(HIVDxAge, na.rm = T), 
                 sd=sd(HIVDxAge, na.rm = T), 
                 min=min(HIVDxAge, na.rm = TRUE), 
                 max=max(HIVDxAge, na.rm=TRUE))
               ][
                 ]

## discretized
breaks = c(0, 19, 25, 35, 45, 55, 100)
labels = c("<=18", "19-24", "25-34", "35-44", "45-54", ">=55")

individuals_dt[individuals_in_net_dt_studyidfrom, 
               hivdxage_cat := 
                        cut(HIVDxAge, breaks = breaks, 
                            labels = labels)]

hivdxage_cat_dt <- 
  individuals_dt[individuals_in_net_dt_studyidfrom, 
               .(.N), by=hivdxage_cat][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdxage_cat)]
hivdxage_cat_dt
sum(hivdxage_cat_dt$N)

## Who are the people here who do not have a reported age for diagnosis?
na_hivdxage_cat_dt <- individuals_dt[intersect(individuals_in_net_dt_studyidfrom, which(is.na(individuals_dt$hivdxage_cat))),]
dim(na_hivdxage_cat_dt)
#View(na_hivdxage_cat_dt)
#View(individuals_dt[individuals_in_net_dt_studyidfrom, .SD, .SDcols=c("StudyID", "Source", "HIVDxDate", "HIVDxAge", "hivdxage_cat")])

```

```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, lapply(.SD, function (x) length(x)), by=Source]
```

#### HIV Diagnosis Year

```{r}
index_persons_dt <- individuals_dt[individuals_in_net_dt_studyidfrom,]
index_persons_dt[, hivdiagnosis_year := as.numeric(substr(HIVDxDate, 1, 4))]
table(index_persons_dt$hivdiagnosis_year)

breaks = c(0, 2000, 2006, 2011, 2021)
labels = c("<2000", "2001-2005", "2006-2010", "2011-2020")

index_persons_dt[, hivdiagnosis_year_group := 
                        cut(hivdiagnosis_year, breaks = breaks, 
                            labels = labels)]
table(index_persons_dt$hivdiagnosis_year_group, exclude = NULL)

index_persons_dt[, .(.N), by=hivdiagnosis_year_group][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdiagnosis_year_group)]
```


There are 40 individuals who do not have a reported year of HIV Diagnosis. 
All of these are persons whose source is RIDOH. 

```{r}
index_persons_dt[which(is.na(hivdiagnosis_year)), .SD, .SDcols=c("StudyID", "Source", "DemoGender", "HIVDxDate", "HIVDxAge", "hivdiagnosis_year", "hivdiagnosis_year_group")]
```


#### Last HIV Negative Test Year

```{r}

notna_hivlastnegyear <- which(!is.na(individuals_dt$HIVLastNegativeYear))

individuals_dt[intersect(individuals_in_net_dt_studyidfrom, notna_hivlastnegyear), 
               .(.N), 
               by=.(HIVLastNegativeYear)
               ][]
                 


lasthivneg_by_year_dt <-
  individuals_dt[intersect(individuals_in_net_dt_studyidfrom, notna_hivlastnegyear), .(.N), 
               by=.(HIVLastNegativeYear)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][order(HIVLastNegativeYear)
                 ]
lasthivneg_by_year_dt
breaks = c(0, 2000, 2006, 2011, 2021)
labels = c("<2000", "2001-2005", "2006-2010", "2011-2020")

lasthivneg_by_year_dt[, hivlastnegativeyear_group := 
                        cut(HIVLastNegativeYear, breaks = breaks, 
                            labels = labels)]

lasthivneg_by_year_dt[, .(.N), by=hivlastnegativeyear_group][,
                 "prop":=round(N/sum(N), 3)
                 ][]
```
#### Behavioral Characteristics: MSM, IDU, HRH

```{r}
index_persons_dt[, .(.N), by=RiskMSM][,
                 "prop":=round(N/sum(N), 3)
                 ][]

index_persons_dt[, .(.N), by=RiskIDU][,
                 "prop":=round(N/sum(N), 3)
                 ][]

index_persons_dt[, .(.N), by=RiskHRH][,
                 "prop":=round(N/sum(N), 3)
                 ][]
```


### Describe the demographic and behavioral characteristics of partner contacts 




### Consolidate Table 1.


