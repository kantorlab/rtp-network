---
title: 'Table `1`: Descriptives of Index and Partner Cases'
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

### Objective 

The purpose here is to create a prototype of Table 1 - summarizing demographic
and behavioral characteristics of index persons and their contacts.



```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE,
                      root.dir = '~/code/rtp-network/out/')

library(data.table)
library(dplyr)
library(stringi)
library(network)
```



```{r read_data, include=FALSE}
data_dir <- "/gpfs/data/rkantor/rtp/datasets/D30_20211013_V1"
list.files(path=data_dir)
net_dt <- as.data.table(read.csv(paste0(data_dir, "/ContactTracingNetwork.csv")))
individuals_dt <- as.data.table(read.csv(paste0(data_dir, "/Individuals.csv")))


```

### Structure of the **Unified** Individuals' Database 

How many unique persons in the individuals database?

```{r}

head(individuals_dt)

nrow(individuals_dt)
length(unique(individuals_dt$StudyID))

table(substr(individuals_dt$StudyID, 1, 3))
```
**Note**: There are no persons with "CONTACT" Study ID in the individuals
database. 

What is the source of the information of persons in the individuals database?

```{r}
table(individuals_dt$Source, exclude = NULL)
table(individuals_dt$Source, exclude = NULL)/sum(table(individuals_dt$Source, exclude = NULL))
```

```{r}
colnames(individuals_dt)
#matrix(cbind(1:ncol(individuals_dt), colnames(individuals_dt)), nrow=22, ncol=4)
```

```{r}
individuals_dt[Source=="RIDOH", .SD, .SDcols=c(1:34)]
lapply(individuals_dt, summary)

summarize_cols <- function(x){
  if(is.numeric(x)) {
    summary(x)
    } else if (!is.numeric(x)) { 
      table(x)
    }
}

#lapply(individuals_dt, summarize_cols)
```

```{r}
summary(individuals_dt$HIVDxAge)

individuals_dt[, summary(.SD), .SDcols = "HIVDxAge"]

individuals_dt[Source=="ICDB", summary(.SD), .SDcols = "HIVDxAge"]
individuals_dt[Source=="RIDOH", summary(.SD), .SDcols = "HIVDxAge"]
```

```{r}
individuals_dt[, table(.SD), .SDcols = "Outcome"]
```

## Structure of the Partner Database

```{r}
dim(net_dt)
```

The partner data are 4070 observations and 24 variables.


What is the structure of the StudyIDFrom and StudyIDTo columns in the 
partner database?

The first column is “StudyIDFrom” - persons who are interviewed to obtain partner information. This column includes persons who are recruited because they are reported on by an index person. This column is distributed as: persons who come from ICDB (assigned S numbers, n=1841); who come from the RIDOH database (assigned RIDOH numbers, n= 356), and Contacts (n=1873).

```{r, studyidfrom}
head(net_dt)

nrow(net_dt)
length(unique(net_dt$StudyIDFrom))

table(substr(net_dt$StudyIDFrom, 1, 3), exclude = NULL)

table(substr(net_dt$StudyIDFrom, 1, 1), exclude = NULL)

#table(substr(net_dt$StudyIDFrom, 1, 3), exclude = NULL)[["CON"]] + length(unique(net_dt$StudyIDFrom))
```
What is the structure of the persons (i.e., "STUDYIDTos") that the StudyIDFrom's 
are reporting on?


```{r, studyidto}
nrow(net_dt)
length(unique(net_dt$StudyIDTo))

table(substr(net_dt$StudyIDTo, 1, 1), exclude = NULL)
```

Distribution of "StudyIDTos" reported by S persons, RIDOH persons, and contacts:

```{r}
# Reported by S persons
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "S")]$StudyIDTo, 1, 1), exclude = NULL)

# Reported by R persons
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "R")]$StudyIDTo, 1, 1), exclude = NULL)

# Reported by Contacts
table(substr(net_dt[which(substr(StudyIDFrom, 1, 1) == "C")]$StudyIDTo, 1, 1), exclude = NULL)
```

Characterize the other variables appearing the partner dataset:

### Interview Characteristics

```{r}
table(stri_sub(net_dt$InterviewID, -1, -1), exclude = NULL)
table(net_dt$InterviewRank, exclude = NULL)
table(stri_sub(net_dt$InterviewRank, -1, -1), exclude = NULL)
table(net_dt$InterviewType, exclude = NULL)

idx_client_newdiag_dt <- net_dt[InterviewType == "Index Client - New diagnosis"]
idx_client_highvl_dt <- net_dt[InterviewType == "Index Client - In care, high viral load"]
```

### Referral/Reporting Characteristics of Index Persons

```{r}
reported_true_dt <- net_dt[which(Reported == "True"),,]
not_reported_dt <- net_dt[which(Reported == ""),,]

reported_true_dt$IndexHIVTestDate
nohivtestdt_among_reported_idx <- which(reported_true_dt$IndexHIVTestDate == "")
reported_true_dt[nohivtestdt_among_reported_idx,]

table(substr(reported_true_dt[nohivtestdt_among_reported_idx,]$StudyIDFrom, 1, 1), 
      exclude = NULL)


```


### Characteristics of reported partner contacts

```{r}
table(net_dt$IdentifiedDate, exclude = NULL)
table(net_dt$IdentifiedRisk, exclude = NULL)
table(net_dt$Notify, exclude = NULL)
table(net_dt$NotifyWho, exclude = NULL)
table(net_dt$NotifyMethod, exclude = NULL)
table(net_dt$AlreadyIndexCase, exclude = NULL)
table(net_dt$ClientReached, exclude = NULL)
table(net_dt$ClientNotReached, exclude = NULL)
length(which(net_dt$PartnerServicesOfferedDate != ""))
#View(net_dt[which(net_dt$PartnerServicesOfferedDate != ""),,])
net_dt[which(net_dt$PartnerServicesOfferedDate!=""), .N,
       by="PartnerServicesAccepted"][]
```


### Analyze the individuals who are intervewed in the partner dataset
How many of the `r length(unique(individuals_dt$StudyID))` individuals appear 
in the partner database, as ``StudyIDFrom'' or ``StudyIDTo''?

```{r}
individuals_in_net_dt_studyidfrom <- which(individuals_dt$StudyID %in% net_dt$StudyIDFrom)
length(individuals_in_net_dt_studyidfrom)

individuals_in_net_dt_studyidto <- which(individuals_dt$StudyID %in% net_dt$StudyIDTo)
length(individuals_in_net_dt_studyidto)
```

There are `r length(individuals_in_net_dt_studyidfrom)` unique individuals in the
StudyIDFrom column in the partner contact database. 

### Describe the demographic and behavioral characteristics of the index persons 
This would include individuals who are also in the partner database (n = `r length(individuals_in_net_dt_studyidfrom)`)

### [Table "1"](https://docs.google.com/document/d/12g9p5gsKfzjGl-hP524krx7GwZPHGY1UBvMf_7cMo8I/edit#bookmark=id.tc8pri6l7bee)  
**Descriptive Characteristics of Index Persons and Partner Contacts**


#### By source

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(n_source=.N), 
               by=.(Source)
               ][,
                 "prop":=round(n_source/sum(n_source), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidto, .(n_source=.N), 
               by=.(Source)
               ][,
                 "prop":=round(n_source/sum(n_source), 3)
                 ][
                 ]
```

#### Gender and Birth Sex

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoGender)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoBirthSex)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidto, .(.N), 
               by=.(DemoGender)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidto, .(.N), 
               by=.(DemoBirthSex)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]
```

#### Race and Ethnicity

```{r, include=TRUE, echo=TRUE}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoRace)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(DemoHispanic)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

# individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
#                by=.(DemoRace, DemoHispanic)
#                ][,
#                  "prop":=round(N/sum(N), 3)
#                  ][
#                  ][order(DemoRace)]


individuals_dt[individuals_in_net_dt_studyidto, .(.N), 
               by=.(DemoRace)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

individuals_dt[individuals_in_net_dt_studyidto, .(.N), 
               by=.(DemoHispanic)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][
                 ]

```

#### Year of HIV Diagnosis 

**Index Persons**
```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, .(.N), 
               by=.(hiv_diag_year=substr(HIVDxDate, 1, 4))
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hiv_diag_year)
                 ]
```


**Partner Contacts**
```{r}
individuals_dt[individuals_in_net_dt_studyidto, .(.N), 
               by=.(hiv_diag_year=substr(HIVDxDate, 1, 4))
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hiv_diag_year)
                 ]
```

#### Age at HIV Diagnosis

**Index Persons** 

```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, 
               .(mean=mean(HIVDxAge, na.rm=T), 
                 median=median(HIVDxAge, na.rm = T), 
                 sd=sd(HIVDxAge, na.rm = T), 
                 min=min(HIVDxAge, na.rm = TRUE), 
                 max=max(HIVDxAge, na.rm=TRUE))
               ][
                 ]

## discretized
breaks = c(0, 19, 25, 35, 45, 55, 100)
labels = c("<=18", "19-24", "25-34", "35-44", "45-54", ">=55")

individuals_dt[individuals_in_net_dt_studyidfrom, 
               hivdxage_cat := 
                        cut(HIVDxAge, breaks = breaks, 
                            labels = labels)]

hivdxage_cat_dt <- 
  individuals_dt[individuals_in_net_dt_studyidfrom, 
               .(.N), by=hivdxage_cat][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdxage_cat)]
hivdxage_cat_dt
sum(hivdxage_cat_dt$N)

## Who are the people here who do not have a reported age for diagnosis?
na_hivdxage_cat_dt <- individuals_dt[intersect(individuals_in_net_dt_studyidfrom, which(is.na(individuals_dt$hivdxage_cat))),]
dim(na_hivdxage_cat_dt)
knitr::kable(na_hivdxage_cat_dt)
knitr::kable(individuals_dt[individuals_in_net_dt_studyidfrom, .SD, .SDcols=c("StudyID", "Source", "HIVDxDate", "HIVDxAge", "hivdxage_cat")])

```
**Partner Contacts**

```{r}
individuals_dt[individuals_in_net_dt_studyidto, 
               .(mean=mean(HIVDxAge, na.rm=T), 
                 median=median(HIVDxAge, na.rm = T), 
                 sd=sd(HIVDxAge, na.rm = T), 
                 min=min(HIVDxAge, na.rm = TRUE), 
                 max=max(HIVDxAge, na.rm=TRUE))
               ][
                 ]

## discretized
breaks = c(0, 19, 25, 35, 45, 55, 100)
labels = c("<=18", "19-24", "25-34", "35-44", "45-54", ">=55")

individuals_dt[individuals_in_net_dt_studyidto, 
               hivdxage_cat := 
                        cut(HIVDxAge, breaks = breaks, 
                            labels = labels)]

hivdxage_cat_dt <- 
  individuals_dt[individuals_in_net_dt_studyidto, 
               .(.N), by=hivdxage_cat][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdxage_cat)]
hivdxage_cat_dt
sum(hivdxage_cat_dt$N)

## Who are the people here who do not have a reported age for diagnosis?
na_hivdxage_cat_dt <- individuals_dt[intersect(individuals_in_net_dt_studyidto, which(is.na(individuals_dt$hivdxage_cat))),]
dim(na_hivdxage_cat_dt)
knitr::kable(na_hivdxage_cat_dt)
knitr::kable(individuals_dt[individuals_in_net_dt_studyidto, .SD, .SDcols=c("StudyID", "Source", "HIVDxDate", "HIVDxAge", "hivdxage_cat")])

```

```{r}
individuals_dt[individuals_in_net_dt_studyidfrom, lapply(.SD, function (x) length(x)), by=Source]
```

#### HIV Diagnosis Year

**Index Persons**
```{r}
index_persons_dt <- individuals_dt[individuals_in_net_dt_studyidfrom,]
index_persons_dt[, hivdiagnosis_year := as.numeric(substr(HIVDxDate, 1, 4))]
table(index_persons_dt$hivdiagnosis_year)

breaks = c(0, 2000, 2006, 2011, 2021)
labels = c("<2000", "2001-2005", "2006-2010", "2011-2020")

index_persons_dt[, hivdiagnosis_year_group := 
                        cut(hivdiagnosis_year, breaks = breaks, 
                            labels = labels)]
table(index_persons_dt$hivdiagnosis_year_group, exclude = NULL)

index_persons_dt[, .(.N), by=hivdiagnosis_year_group][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdiagnosis_year_group)]
```

```{r}
index_persons_dt[which(is.na(hivdiagnosis_year)), .SD, .SDcols=c("StudyID", "Source", "DemoGender", "HIVDxDate", "HIVDxAge", "hivdiagnosis_year", "hivdiagnosis_year_group")]
```

There are 40 index persons who do not have a reported year of HIV Diagnosis. 
All of these are persons whose source is RIDOH. 

**Partner Contacts**
```{r}
partner_contacts_dt <- individuals_dt[individuals_in_net_dt_studyidto,]
partner_contacts_dt[, hivdiagnosis_year := as.numeric(substr(HIVDxDate, 1, 4))]
table(partner_contacts_dt$hivdiagnosis_year)

breaks = c(0, 2000, 2006, 2011, 2021)
labels = c("<2000", "2001-2005", "2006-2010", "2011-2020")

partner_contacts_dt[, hivdiagnosis_year_group := 
                        cut(hivdiagnosis_year, breaks = breaks, 
                            labels = labels)]
table(partner_contacts_dt$hivdiagnosis_year_group, exclude = NULL)

partner_contacts_dt[, .(.N), by=hivdiagnosis_year_group][,
                 "prop":=round(N/sum(N), 3)
                 ][order(hivdiagnosis_year_group)]
```




#### Last HIV Negative Test Year

```{r}

notna_hivlastnegyear <- which(!is.na(individuals_dt$HIVLastNegativeYear))

individuals_dt[intersect(individuals_in_net_dt_studyidfrom, notna_hivlastnegyear), 
               .(.N), 
               by=.(HIVLastNegativeYear)
               ][]
                 


lasthivneg_by_year_dt <-
  individuals_dt[intersect(individuals_in_net_dt_studyidfrom, notna_hivlastnegyear), .(.N), 
               by=.(HIVLastNegativeYear)
               ][,
                 "prop":=round(N/sum(N), 3)
                 ][order(HIVLastNegativeYear)
                 ]
lasthivneg_by_year_dt
breaks = c(0, 2000, 2006, 2011, 2021)
labels = c("<2000", "2001-2005", "2006-2010", "2011-2020")

lasthivneg_by_year_dt[, hivlastnegativeyear_group := 
                        cut(HIVLastNegativeYear, breaks = breaks, 
                            labels = labels)]

lasthivneg_by_year_dt[, .(.N), by=hivlastnegativeyear_group][,
                 "prop":=round(N/sum(N), 3)
                 ][]
```
#### Behavioral Characteristics: MSM, IDU, HRH

**Index Persons**
```{r}
index_persons_dt[, .(.N), by=RiskMSM][,
                 "prop":=round(N/sum(N), 3)
                 ][]

index_persons_dt[, .(.N), by=RiskIDU][,
                 "prop":=round(N/sum(N), 3)
                 ][]

index_persons_dt[, .(.N), by=RiskHRH][,
                 "prop":=round(N/sum(N), 3)
                 ][]
```

**Partner Contacts**
```{r}
partner_contacts_dt[, .(.N), by=RiskMSM][,
                 "prop":=round(N/sum(N), 3)
                 ][]

partner_contacts_dt[, .(.N), by=RiskIDU][,
                 "prop":=round(N/sum(N), 3)
                 ][]

partner_contacts_dt[, .(.N), by=RiskHRH][,
                 "prop":=round(N/sum(N), 3)
                 ][]
```

### [Table 2]()  
**Mean number of named, diagnosed and sequenced partners by index case characteristics**

```{r}
#knitr::kable(net_dt)
```

To focus on index persons with a named person, 
filter out rows with missing `StudyIDTo`:

```{r}
no_missing_rows_in_net_dt <- net_dt[StudyIDTo != "", , ]
class(no_missing_rows_in_net_dt)
```



- Start by computing the mean number of *named partners* for all index persons?
- Then break down this list by index person behavioral and demographic characteristics?

Number of contacts reported by each index person: 


#### Analysis of named partners for all index persons

```{r}
net_dt[, .N, by = StudyIDFrom] #full dataset
#net_dt[StudyIDFrom == "S20000441296", ]

no_missing_rows_in_net_dt[, .N, by = StudyIDFrom] #IPs with named partners only
#no_missing_rows_in_net_dt[StudyIDFrom == "S20000441296", ]
```

Number of unique contacts reported by each index person:

```{r}
net_dt[, .(UniqueContacts = uniqueN(StudyIDTo)), by = StudyIDFrom]

unique_contacts_counts <- no_missing_rows_in_net_dt[, .(UniqueContacts = uniqueN(StudyIDTo)), by = StudyIDFrom]

sum(unique_contacts_counts$UniqueContacts)
```
Count the number of times each contact has been reported:

```{r}
summary(as.numeric(table(net_dt$StudyIDTo)[-1]))

summary(as.numeric(table(no_missing_rows_in_net_dt$StudyIDTo)))
```

```{r}
individuals_in_net_dt_studyidfrom_nomiss <- which(individuals_dt$StudyID %in% no_missing_rows_in_net_dt$StudyIDFrom)
length(individuals_in_net_dt_studyidfrom_nomiss)

individuals_in_net_dt_studyidto_nomiss <- which(individuals_dt$StudyID %in% no_missing_rows_in_net_dt$StudyIDTo)
length(individuals_in_net_dt_studyidto_nomiss)
```

How many unique partners are reported by indexed persons with named partners?

```{r}
length(no_missing_rows_in_net_dt$StudyIDTo)
length(unique(no_missing_rows_in_net_dt$StudyIDTo))
```

What is the distribution of unique partners reported by indexed persons with named partners?

```{r}
pts_reported_by_IPs_with_named_pts <- no_missing_rows_in_net_dt[,.N,by=StudyIDFrom]
dim(pts_reported_by_IPs_with_named_pts)
summary(pts_reported_by_IPs_with_named_pts$N)

idxs <- which(pts_reported_by_IPs_with_named_pts$StudyIDFrom %in% individuals_dt$StudyID == TRUE)
IPs_reporting_partners_in_unified_dt <- pts_reported_by_IPs_with_named_pts$StudyIDFrom[idxs]
```

Of these `length(unique(no_missing_rows_in_net_dt$StudyIDTo))`, how many appear
in the unified individuals data set and how many are diagnosed?

**N.B.**: Date of HIV Diagnosis is used to indicate whether a person is diagnosed.

```{r}
unique_named_pt_contacts_reported_by_IPs <- unique(no_missing_rows_in_net_dt$StudyIDTo)

which(unique_named_pt_contacts_reported_by_IPs %in% individuals_dt$StudyID)

named_contacts_in_unified_dataset <- unique_named_pt_contacts_reported_by_IPs[which(unique_named_pt_contacts_reported_by_IPs %in% individuals_dt$StudyID)]


named_contacts_rows_from_unified_dt <- individuals_dt[StudyID %in% named_contacts_in_unified_dataset,,]
named_contacts_rows_from_unified_dt$HIVDxDate
length(named_contacts_rows_from_unified_dt$HIVDxDate)
length(which(named_contacts_rows_from_unified_dt$HIVDxDate == ""))
table(individuals_dt[StudyID %in% named_contacts_in_unified_dataset,,]$HIVDxDate, exclude = NULL)
```

How many are sequenced?

```{r}
table(named_contacts_rows_from_unified_dt$Sequence, exclude = NULL)
```

#### Analysis of named partners for index persons stratified by behavior,
race, ethnicity.

**MSM**:

Number of index persons (with named partners) who identify as MSM:

```{r}
individuals_dt_of_msm_who_named_partners <-
  individuals_dt[StudyID %in% IPs_reporting_partners_in_unified_dt & RiskMSM == "True",,]
nrow(individuals_dt_of_msm_who_named_partners)
```

**How many partners are reported by the `r nrow(individuals_dt_of_msm_who_named_partners)` MSM persons who named partners?**

```{r}
net_dt_of_msm_who_named_partners <- net_dt[StudyIDFrom %in% individuals_dt_of_msm_who_named_partners$StudyID,,] 

pt_counts_msm_who_named_partners <- net_dt_of_msm_who_named_partners[,.(N=.N),by=StudyIDFrom]

nrow(pt_counts_msm_who_named_partners)
pt_counts_msm_who_named_partners[,sum(N)]
pt_counts_msm_who_named_partners[,summary(N)]
```

**Ans: `r pt_counts_msm_who_named_partners[,sum(N)]`**.

**How many of these partners are in the individuals dataset, diagnosed, and sequenced?**

```{r}
idx <- which(net_dt_of_msm_who_named_partners$StudyIDTo %in% individuals_dt$StudyID)
msm_reported_partners_in_individuals_dt <- net_dt_of_msm_who_named_partners$StudyIDTo[idx] 
unique(msm_reported_partners_in_individuals_dt)

msm_partners_in_individuals_full_dt <- individuals_dt[StudyID %in% msm_reported_partners_in_individuals_dt,,]
table(msm_partners_in_individuals_full_dt$HIVDxDate, exclude = NULL)
table(msm_partners_in_individuals_full_dt$Sequence, exclude = NULL)
```


**IDU**:

```{r}
nrow(individuals_dt[StudyID %in% IPs_reporting_partners_in_unified_dt & RiskIDU == "True",,])
```
**HRH**:

```{r}
nrow(individuals_dt[StudyID %in% IPs_reporting_partners_in_unified_dt & RiskHRH == "True",,])
```
