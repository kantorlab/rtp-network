---
title: "R Notebook"
output: html_notebook
---

# Setup

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE,
                      root.dir = '~/code/rtp-network/out/')
library(data.table)
library(dplyr)
library(stringi)
library(network)
```

# Load the data

```{r}
eda_env <- readRDS("/users/akhann16/code/rtp-network/out/eda_objects.rds")

individuals_dt <- eda_env$individuals_dt
net_dt <- eda_env$net_dt 
named_pt_idx_005 <- eda_env$named_pt_idx_005 
named_pt_idx_015 <- eda_env$named_pt_idx_015
```

# Create a named partner network object

```{r}
net_dt_mat <- cbind(as.character(net_dt[,1]), as.character(net_dt[,2]))
net <- as.network(net_dt_mat, bipartite = F, directed = T)
net
length(net %v% "vertex.names")
head(net %v% "vertex.names")
named_pt_net <- net
```


# Recode Sequence Subtype as B/non-B (needed for regressions):

```{r}
individuals_dt$RecodedSequenceSubtype <- 
  ifelse(individuals_dt$SequenceSubtype == "" | individuals_dt$SequenceSubtype == "B", 
         individuals_dt$SequenceSubtype, 
         "non-B")

```



# Create edgelists from molecular clusters

Start by converting the unified individuals dataset
to an edgelist depending on cluster identity by molecular cluster identification
technique.  

## Function 
Write a single function that can handle any of the three cluster cols
(HIVTrace005, HIVTrace015, ClusteredPhyloAny):

```{r}
create_edgelists <- function(data, cluster_col, edgelist_prefix) {
  # data: a data frame containing the data to generate edgelists from
  # cluster_col: the name of the column containing the cluster IDs
  # edgelist_prefix: a user-specified prefix to add to the names of the edgelists generated by the function
  
  # Get a list of unique cluster IDs from the specified column of the data frame
  unique_clusters <- unique(na.omit(data[[cluster_col]]))

  # Loop through the unique clusters and create an edgelist for each
  edgelists <- list()
  for (i in 1:length(unique_clusters)) {
    # Get the cluster ID
    cluster_id <- unique_clusters[i]
    
    # Skip to next iteration if cluster_id is empty or NA
    if (cluster_id == "" || is.na(cluster_id)) {
      next
    }
    
    # Print the cluster ID
    #print(paste("Processing cluster", cluster_id))
    
    # Filter the data frame to include only the rows corresponding to the current cluster ID
    df_cluster <- data[data[[cluster_col]] == cluster_id, ]
    
    # Get a list of unique nodes in the current cluster
    nodes <- unique(df_cluster$StudyID)
    #print(nodes)
    #print("Length of nodes: ", length(nodes))
    
    # Skip to next iteration if nodes is empty
    if (length(nodes) <= 1) {
      next
    }
    
    # Use combn() to get all combinations of nodes within the current cluster
    edges <- combn(nodes, 2) %>%
      t() %>%
      as.data.frame() %>%
      filter(V1 != V2) %>%
      distinct() %>%
      rename(source = V1, target = V2)
    
    # Add a column indicating the cluster ID for each edge
    edges$cluster_id <- cluster_id
    
    # Set the name of the edgelist
    edgelist_name <- paste(edgelist_prefix, cluster_id, sep = "_")
    
    # Store the edgelist in the list of edgelists
    edgelists[[edgelist_name]] <- edges
  }
  
  # Combine all edgelists into a single edgelist
  all_edges <- do.call(rbind, edgelists)
  
  return(all_edges)
}

```

## Apply the function:

```{r}
# Generate edgelists for ClusteredPhyloAny column
phylo_data <-
  individuals_dt[!is.na(individuals_dt$ClusteredPhyloAny),] 
#function needs for NA vals in ClusteredPhyloAny to be removed for it to run
phylo_edgelist <-
  create_edgelists(data = phylo_data,
                   cluster_col = "ClusteredPhyloAny",
                   edgelist_prefix = "phylo_edgelist")


# Generate edgelists for ClusteredHIVTrace005 column
hivtrace005_edgelist <-
  create_edgelists(data = individuals_dt,
                   cluster_col = "ClusteredHIVTrace005",
                   edgelist_prefix = "005_edgelist")

# Generate edgelists for ClusteredHIVTrace015 column
hivtrace015_edgelist <-
  create_edgelists(data = individuals_dt,
                   cluster_col = "ClusteredHIVTrace015",
                   edgelist_prefix = "015_edgelist")

```

## Tests 

* For Trace 005
```{r}
x <- as.numeric(table(individuals_dt$ClusteredHIVTrace005)[-1])
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(hivtrace005_edgelist))
```

* For Trace 015
```{r}
x <- as.numeric(table(individuals_dt$ClusteredHIVTrace015)[-1])
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(hivtrace015_edgelist))
```

* For ClusteredPhyloAny

```{r}
x <- as.numeric(table(individuals_dt$ClusteredPhyloAny))
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(phylo_edgelist))
```

# Regresssions

## Table 4A: Logistic regression on index case being genetically 
linked to at least one of their named partners

### Prepare data for regression analysis

- How many index persons are in the HIVTrace005, HIVTrace015 and ClusteredPhyloAny datasets?

```{r}
index_person_idx_in_005 <- which(individuals_dt$ClusteredHIVTrace005 != "")
index_persons_in_005 <- individuals_dt$StudyID[index_person_idx_in_005]
length(index_person_idx_in_005)
length(which(individuals_dt$ClusteredHIVTrace005 == ""))
length(which(individuals_dt$ClusteredHIVTrace005 == "")) == 
         table(individuals_dt$ClusteredHIVTrace005)[[]]
individuals_dt_w_index_persons_in_005 <- individuals_dt[index_person_idx_in_005,]
dim(individuals_dt_w_index_persons_in_005)

index_person_idx_in_015 <- which(individuals_dt$ClusteredHIVTrace015 != "")
index_persons_in_015 <- individuals_dt$StudyID[index_person_idx_in_015]
length(index_person_idx_in_015)
length(which(individuals_dt$ClusteredHIVTrace015 == ""))
length(which(individuals_dt$ClusteredHIVTrace015 == "")) == 
         table(individuals_dt$ClusteredHIVTrace015)[[]]
individuals_dt_w_index_persons_in_015 <- individuals_dt[index_person_idx_in_015,]
dim(individuals_dt_w_index_persons_in_015)

index_person_idx_in_clusteredphyloany <- which(individuals_dt$ClusteredPhyloAny != "")
index_persons_in_clusteredphyloany <- individuals_dt$StudyID[index_person_idx_in_clusteredphyloany]
length(index_person_idx_in_clusteredphyloany)
length(which(is.na(individuals_dt$ClusteredPhyloAny)))
individuals_dt_w_index_persons_in_clusteredphyloany <- individuals_dt[index_person_idx_in_clusteredphyloany,]
dim(individuals_dt_w_index_persons_in_clusteredphyloany)
```

- How many of these index persons from each molecular clustering variable are in the named partner list?

```{r}
#named_pt_net%v% "vertex.names"
trace005_persons_in_named_pt_net_idx <- which((index_persons_in_005) %in% (named_pt_net %v% "vertex.names"))
trace015_persons_in_named_pt_net_idx <- which((index_persons_in_015) %in% (named_pt_net %v% "vertex.names"))
clusteredphyloany_persons_in_named_pt_net_idx <- which((index_persons_in_clusteredphyloany) %in% (named_pt_net %v% "vertex.names"))

individuals_dt_w_index_persons_in_005$named_partner_indicator <- 0
individuals_dt_w_index_persons_in_005$named_partner_indicator[trace005_persons_in_named_pt_net_idx] <- 1
individuals_dt_w_index_persons_in_005$named_partner_indicator <- as.factor(individuals_dt_w_index_persons_in_005$named_partner_indicator)

individuals_dt_w_index_persons_in_015$named_partner_indicator <- 0
individuals_dt_w_index_persons_in_015$named_partner_indicator[trace015_persons_in_named_pt_net_idx] <- 1
individuals_dt_w_index_persons_in_015$named_partner_indicator <-
  as.factor(individuals_dt_w_index_persons_in_015$named_partner_indicator)

individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator <- 0
individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator[
  clusteredphyloany_persons_in_named_pt_net_idx
  ] <-  1
individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator <-
  as.factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator)

dim(individuals_dt_w_index_persons_in_clusteredphyloany)
table(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
```


- Split the above counts by attributes

Trace 005:
```{r}
table(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_dt_w_index_persons_in_005$DemoGender, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$DemoGender, exclude = NULL) +
  factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
   )
   
## DemoRace
table(individuals_dt_w_index_persons_in_005$DemoRace, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$DemoRace, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
 )

## Sequence
table(individuals_dt_w_index_persons_in_005$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
 )

## MSM
table(individuals_dt_w_index_persons_in_005$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$RiskMSM, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
 )

## Heterosexual
table(individuals_dt_w_index_persons_in_005$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$RiskHeterosexual, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
 )

## IDU
table(individuals_dt_w_index_persons_in_005$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_005$RiskIDU, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_005$named_partner_indicator, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_dt_w_index_persons_in_005$HIVDxAge)
individuals_dt_w_index_persons_in_005 %>%
  group_by(named_partner_indicator) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```



Trace 015:
```{r}

table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_dt_w_index_persons_in_015$DemoGender, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$DemoGender, exclude = NULL) +
  factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
   )
   
## DemoRace
table(individuals_dt_w_index_persons_in_015$DemoRace, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$DemoRace, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
 )

## Sequence
table(individuals_dt_w_index_persons_in_015$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
 )

## MSM
table(individuals_dt_w_index_persons_in_015$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$RiskMSM, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
 )

## Heterosexual
table(individuals_dt_w_index_persons_in_015$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$RiskHeterosexual, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
 )

## IDU
table(individuals_dt_w_index_persons_in_015$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_015$RiskIDU, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_dt_w_index_persons_in_015$HIVDxAge)
individuals_dt_w_index_persons_in_015 %>%
  group_by(named_partner_indicator) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```

Clustered Phlyo Any:
```{r}

table(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_dt_w_index_persons_in_clusteredphyloany$DemoGender, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$DemoGender, exclude = NULL) +
  factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
   )
   
## DemoRace
table(individuals_dt_w_index_persons_in_clusteredphyloany$DemoRace, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$DemoRace, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
 )

## Sequence
table(individuals_dt_w_index_persons_in_clusteredphyloany$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
 )

## MSM
table(individuals_dt_w_index_persons_in_clusteredphyloany$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$RiskMSM, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
 )

## Heterosexual
table(individuals_dt_w_index_persons_in_clusteredphyloany$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$RiskHeterosexual, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
 )

## IDU
table(individuals_dt_w_index_persons_in_clusteredphyloany$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_dt_w_index_persons_in_clusteredphyloany$RiskIDU, exclude = NULL) +
factor(individuals_dt_w_index_persons_in_clusteredphyloany$named_partner_indicator, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_dt_w_index_persons_in_clusteredphyloany$HIVDxAge)
individuals_dt_w_index_persons_in_clusteredphyloany %>%
  group_by(named_partner_indicator) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```


### Write a function to run the regression model:

```{r}
run_analysis <- function(dataset) {
  # Model 1: DemoGender
  
  # recode DemoGender to combine XMF and not reported into one category
  dataset$DemoGender <- as.character(dataset$DemoGender)
  dataset$DemoGender[dataset$DemoGender %in% c("XMF", "")] <- "XMF_not_reported"
  dataset$DemoGender <- as.factor(dataset$DemoGender)
  
  # relevel DemoGender to make Female the reference category
  dataset$DemoGender <- relevel(dataset$DemoGender, ref = "F")
  
  #fit model
  m1 <- glm(named_partner_indicator ~ DemoGender, data = dataset, family = "binomial")
  m1_summary <- summary(m1)
  xtabs1 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(DemoGender, exclude = NULL), data = dataset)
  
  # Model 2: DemoRace
  # relevel DemoGender to make Black the reference category
  dataset$DemoRace <- as.factor(dataset$DemoRace)
  dataset$DemoRace <- relevel(dataset$DemoRace, ref = "Black")
  
  m2 <- glm(named_partner_indicator ~ DemoRace, data = dataset, family = "binomial")
  m2_summary <- summary(m2)
  xtabs2 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(DemoRace, exclude = NULL), data = dataset)
  
  # Model 3: RecodedSequenceSubtype
  m3 <- glm(named_partner_indicator ~ as.factor(RecodedSequenceSubtype), data = dataset, family = "binomial")
  m3_summary <- summary(m3)
  xtabs3 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(RecodedSequenceSubtype, exclude = NULL), data = dataset)

  # Model 4: RiskMSM
  dataset$RiskMSM <- as.factor(dataset$RiskMSM)
  dataset$RiskMSM <- relevel(dataset$RiskMSM, ref="False")
  
  m4 <- glm(named_partner_indicator ~ RiskMSM, data = dataset, family = "binomial")
  m4_summary <- summary(m4)
  xtabs4 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(RiskMSM, exclude = NULL), data = dataset)

  # Model 5: RiskHeterosexual
  dataset$RiskHeterosexual <- as.factor(dataset$RiskHeterosexual)
  dataset$RiskHeterosexual <- relevel(dataset$RiskHeterosexual, ref="False")
  
  m5 <- glm(named_partner_indicator ~ RiskHeterosexual, data = dataset, family = "binomial")
  m5_summary <- summary(m5)
  xtabs5 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(RiskHeterosexual, exclude = NULL), data = dataset)

  # Model 6: RiskIDU
  dataset$RiskIDU <- as.factor(dataset$RiskIDU)
  dataset$RiskIDU <- relevel(dataset$RiskIDU, ref="False")
  
  m6 <- glm(named_partner_indicator ~ RiskIDU, data = dataset, family = "binomial")
  m6_summary <- summary(m6)
  xtabs6 <- xtabs(~ factor(named_partner_indicator, exclude = NULL) + factor(RiskIDU, exclude = NULL), data = dataset)

  # Model 7: HIVDxAge
  m7 <- glm(named_partner_indicator ~ HIVDxAge, data = dataset, family = "binomial")
  m7_summary <- summary(m7)
  
  return(list(
    DemoGender_summary = m1_summary,
    DemoGender_xtabs = xtabs1,
    DemoRace_summary = m2_summary,
    DemoRace_xtabs = xtabs2,
    RecodedSequenceSubtype_summary = m3_summary,
    RecodedSequenceSubtype_xtabs = xtabs3,
    RiskMSM_summary = m4_summary,
    RiskMSM_xtabs = xtabs4,
    RiskHRH_summary = m5_summary,
    RiskHRH_xtabs = xtabs5,
    RiskIDU_summary = m6_summary,
    RiskIDU_xtabs = xtabs6,
    HIVDxAge_summary = m7_summary
  ))
}
```

### Run the regressions:

```{r}
result_005 <- run_analysis(individuals_dt_w_index_persons_in_005)
result_015 <- run_analysis(individuals_dt_w_index_persons_in_015)
result_clusteredphyloany <- run_analysis(individuals_dt_w_index_persons_in_clusteredphyloany)
```


## Table 4B: Logistic regression on named partners being genetically linked to the index case. 

### Prepare the data

- How many persons appear in the named partner dataset?

```{r}
length(unique(named_pt_net%v% "vertex.names"))
```

- How many of these named persons are in each of the three clusters? 

```{r}
head(named_pt_net%v% "vertex.names", 25)
named_pt_net

named_pts_in_005_clusters_idx <- which((named_pt_net %v% "vertex.names") %in% index_persons_in_005)
length(named_pts_in_005_clusters_idx)
named_pts_in_005_clusters_vname <- (named_pt_net %v% "vertex.names")[named_pts_in_005_clusters_idx]

named_pts_in_015_clusters_idx <- which((named_pt_net %v% "vertex.names") %in% index_persons_in_015)
length(named_pts_in_015_clusters_idx)
named_pts_in_015_clusters_vname <- (named_pt_net %v% "vertex.names")[named_pts_in_015_clusters_idx]

named_pts_in_clusteredphyloany <- which((named_pt_net %v% "vertex.names") %in% index_persons_in_clusteredphyloany)
length(named_pts_in_clusteredphyloany)
named_pts_in_phyloany_clusters_vname <- (named_pt_net %v% "vertex.names")[named_pts_in_clusteredphyloany]

```

- For each clustering algorithm, we want to add an indicator column to 
individuals_in_named_pt_net_dt. 
The indicator is coded 1 if  individuals_in_named_pt_net_dt$StudyID appears in 
named_pts_in_005_clusters_vname (for instance), and 0 otherwise. 

```{r}
individuals_idx_in_named_pt_net <- which(individuals_dt$StudyID %in% (named_pt_net %v% "vertex.names"))
individuals_in_named_pt_net_dt <- individuals_dt[individuals_idx_in_named_pt_net,]
dim(individuals_in_named_pt_net_dt)

individuals_in_named_pt_net_dt <- individuals_in_named_pt_net_dt %>%
  mutate(indicator_005_cluster = as.numeric(StudyID %in% named_pts_in_005_clusters_vname))

individuals_in_named_pt_net_dt <- individuals_in_named_pt_net_dt %>%
  mutate(indicator_015_cluster = as.numeric(StudyID %in% named_pts_in_015_clusters_vname))

individuals_in_named_pt_net_dt <- individuals_in_named_pt_net_dt %>%
  mutate(indicator_phyloany_cluster = as.numeric(StudyID %in% named_pts_in_phyloany_clusters_vname))

```

- Test that the 3 indicator columns are correctly coded. 
The test checks for the following: 
(1) False positives: StudyIDs marked with an indicator of 1 but not present in the corresponding indicator;
(2) False negatives: StudyIDs marked with an indicator of 0 but present in the corresponding indicator;
(3) Length Check: If the total number of rows marked as 1 in the indicator column, which should be equal to the length of named_pts_in_005_clusters_vname.


```{r}
test_indicator_columns <- function(data, column_name, comparison_vector) {
  false_positives <- data[data[[column_name]] == 1 & !data$StudyID %in% comparison_vector,]
  false_negatives <- data[data[[column_name]] == 0 & data$StudyID %in% comparison_vector,]
  total_indicator_ones <- nrow(data[data[[column_name]] == 1, ])
  length_of_vname <- length(comparison_vector)
  
  cat("Testing:", column_name, "\n")
  if (nrow(false_positives) == 0 && nrow(false_negatives) == 0 && total_indicator_ones == length_of_vname) {
    cat("All tests passed for", column_name, "\n\n")
  } else {
    cat("There are", nrow(false_positives), "false positives and", nrow(false_negatives), "false negatives.\n")
    cat("The number of 1's in the", column_name, "column is", total_indicator_ones, "which is not equal to the length of the comparison vector", length_of_vname, "\n\n")
  }
}

# Test each indicator column
test_indicator_columns(individuals_in_named_pt_net_dt, "indicator_005_cluster", named_pts_in_005_clusters_vname)
test_indicator_columns(individuals_in_named_pt_net_dt, "indicator_015_cluster", named_pts_in_015_clusters_vname)
test_indicator_columns(individuals_in_named_pt_net_dt, "indicator_phyloany_cluster", named_pts_in_phyloany_clusters_vname)

```

### Write a function to run the converse analysis:

```{r}
run_analysis_clustering <- function(dataset, clustering_type) {
  # Choose the appropriate clustering indicator variable based on the input clustering type
  if (clustering_type == "005") {
    clustering_indicator <- "indicator_005_cluster"
  } else if (clustering_type == "015") {
    clustering_indicator <- "indicator_015_cluster"
  } else if (clustering_type == "phyloany") {
    clustering_indicator <- "indicator_phyloany_cluster"
  } else {
    stop("Invalid clustering_type. Choose one of '005', '015', or 'phyloany'.")
  }

  # Model 1: DemoGender
  m1 <- glm(as.formula(paste(clustering_indicator, "~ DemoGender")), data = dataset, family = "binomial")
  m1_summary <- summary(m1)
  xtabs1 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(DemoGender, exclude = NULL)")), data = dataset)

  # Model 2: DemoRace
  # relevel DemoGender to make Black the reference category
  dataset$DemoRace <- as.factor(dataset$DemoRace)
  dataset$DemoRace <- relevel(dataset$DemoRace, ref = "Black")
  
  m2 <- glm(as.formula(paste(clustering_indicator, "~ DemoRace")), data = dataset, family = "binomial")
  m2_summary <- summary(m2)
  xtabs2 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(DemoRace, exclude = NULL)")), data = dataset)

  # Model 3: RecodedSequenceSubtype
  # relevel RecodedSequenceSubtype to make B the reference category
  dataset$RecodedSequenceSubtype <- as.factor(dataset$RecodedSequenceSubtype)
  dataset$RecodedSequenceSubtype <- relevel(dataset$RecodedSequenceSubtype, ref = "B")
  
  m3 <- glm(as.formula(paste(clustering_indicator, "~ RecodedSequenceSubtype")), data = dataset, family = "binomial")
  m3_summary <- summary(m3)
  xtabs3 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(RecodedSequenceSubtype, exclude = NULL)")), data = dataset)

  # Model 4: RiskMSM
  # relevel to make non-MSM the reference category
  dataset$RiskMSM <- as.factor(dataset$RiskMSM)
  dataset$RiskMSM <- relevel(dataset$RiskMSM, ref = "False")
  
  m4 <- glm(as.formula(paste(clustering_indicator, "~ RiskMSM")), data = dataset, family = "binomial")
  m4_summary <- summary(m4)
  xtabs4 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(RiskMSM, exclude = NULL)")), data = dataset)

  # Model 5: RiskHRH
  # relevel to make non-HRH the reference category
  dataset$RiskHeterosexual <- as.factor(dataset$RiskHeterosexual)
  dataset$RiskHeterosexual <- relevel(dataset$RiskHeterosexual, ref = "False")
                               
  m5 <- glm(as.formula(paste(clustering_indicator, "~ RiskHeterosexual")), data = dataset, family = "binomial")
  m5_summary <- summary(m5)
  xtabs5 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(RiskHeterosexual, exclude = NULL)")), data = dataset)

  # Model 6: RiskIDU
  # relevel to make non-HRH the reference category
  dataset$RiskIDU <- as.factor(dataset$RiskIDU)
  dataset$RiskIDU <- relevel(dataset$RiskIDU, ref = "False")
  
  m6 <- glm(as.formula(paste(clustering_indicator, "~ RiskIDU")), data = dataset, family = "binomial")
  m6_summary <- summary(m6)
  xtabs6 <- xtabs(as.formula(paste("~ factor(", clustering_indicator, ", exclude = NULL) + factor(RiskIDU, exclude = NULL)")), data = dataset)

  # Model 7: HIVDxAge
  m7 <- glm(as.formula(paste(clustering_indicator, "~ HIVDxAge")), data = dataset, family = "binomial")
  m7_summary <- summary(m7)
  hivdxage_summary <- tapply(dataset$HIVDxAge, dataset[[clustering_indicator]], summary)

    return(list(
    DemoGender_summary = m1_summary,
    DemoGender_xtabs = xtabs1,
    DemoRace_summary = m2_summary,
    DemoRace_xtabs = xtabs2,
    RecodedSequenceSubtype_summary = m3_summary,
    RecodedSequenceSubtype_xtabs = xtabs3,
    RiskMSM_summary = m4_summary,
    RiskMSM_xtabs = xtabs4,
    RiskHRH_summary = m5_summary,
    RiskHRH_xtabs = xtabs5,
    RiskIDU_summary = m6_summary,
    RiskIDU_xtabs = xtabs6,
    HIVDxAge_summary = m7_summary
  ))
}

```

### Apply the function

```{r}
# Run the analysis for the 005 clustering case
results_005_converse <- run_analysis_clustering(individuals_in_named_pt_net_dt, "005")

# Run the analysis for the 015 clustering case
results_015_converse <- run_analysis_clustering(individuals_in_named_pt_net_dt, "015")

# Run the analysis for the phyloany clustering case
results_phyloany_converse <- run_analysis_clustering(individuals_in_named_pt_net_dt, "phyloany")
```


### 005 cluster
```{r}
table(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
#table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
   )
   
## DemoRace
table(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
   )

## Sequence
table(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
 )

## MSM
table(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
 )

## Heterosexual
table(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
 )

## IDU
table(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_005_cluster, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_in_named_pt_net_dt$HIVDxAge)
individuals_in_named_pt_net_dt %>%
  group_by(indicator_005_cluster) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```



### 015 cluster
```{r}
table(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
#table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
   )
   
## DemoRace
table(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
   )

## Sequence
table(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
 )

## MSM
table(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
 )

## Heterosexual
table(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
 )

## IDU
table(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_015_cluster, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_in_named_pt_net_dt$HIVDxAge)
individuals_in_named_pt_net_dt %>%
  group_by(indicator_015_cluster) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```


### phyloanycluster
```{r}
table(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
#table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)

## DemoGender
table(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoGender, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
   )
   
## DemoRace
table(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$DemoRace, exclude = NULL) +
  factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
   )

## Sequence
table(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RecodedSequenceSubtype, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
 )

## MSM
table(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskMSM, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
 )

## Heterosexual
table(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskHeterosexual, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
 )

## IDU
table(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL)
xtabs(~factor(individuals_in_named_pt_net_dt$RiskIDU, exclude = NULL) +
factor(individuals_in_named_pt_net_dt$indicator_phyloany_cluster, exclude = NULL)
 )

## age at HIV diagnosis
summary(individuals_in_named_pt_net_dt$HIVDxAge)
individuals_in_named_pt_net_dt %>%
  group_by(indicator_phyloany_cluster) %>%
  summarise(mean_HIVDxAge = mean(HIVDxAge, na.rm = TRUE))
```

