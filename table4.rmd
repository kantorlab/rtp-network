---
title: "R Notebook"
output: html_notebook
---

# Setup

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE,
                      root.dir = '~/code/rtp-network/out/')
library(data.table)
library(dplyr)
library(stringi)
library(network)
```

# Load the data

```{r}
eda_env <- readRDS("/users/akhann16/code/rtp-network/out/eda_objects.rds")

individuals_dt <- eda_env$individuals_dt
net_dt <- eda_env$net_dt 
named_pt_net <- eda_env$named_pt_net
named_pt_idx_005 <- eda_env$named_pt_idx_005 
named_pt_idx_015 <- eda_env$named_pt_idx_015
```

# Create edgelists from molecular clusters

Start by converting the unified individuals dataset
to an edgelist depending on cluster identity by molecular cluster identification
technique.  

## Function 
Write a single function that can handle any of the three cluster cols
(HIVTrace005, HIVTrace015, ClusteredPhyloAny):

```{r}
create_edgelists <- function(data, cluster_col, edgelist_prefix) {
  # data: a data frame containing the data to generate edgelists from
  # cluster_col: the name of the column containing the cluster IDs
  # edgelist_prefix: a user-specified prefix to add to the names of the edgelists generated by the function
  
  # Get a list of unique cluster IDs from the specified column of the data frame
  unique_clusters <- unique(na.omit(data[[cluster_col]]))

  # Loop through the unique clusters and create an edgelist for each
  edgelists <- list()
  for (i in 1:length(unique_clusters)) {
    # Get the cluster ID
    cluster_id <- unique_clusters[i]
    
    # Skip to next iteration if cluster_id is empty or NA
    if (cluster_id == "" || is.na(cluster_id)) {
      next
    }
    
    # Print the cluster ID
    #print(paste("Processing cluster", cluster_id))
    
    # Filter the data frame to include only the rows corresponding to the current cluster ID
    df_cluster <- data[data[[cluster_col]] == cluster_id, ]
    
    # Get a list of unique nodes in the current cluster
    nodes <- unique(df_cluster$StudyID)
    #print(nodes)
    #print("Length of nodes: ", length(nodes))
    
    # Skip to next iteration if nodes is empty
    if (length(nodes) <= 1) {
      next
    }
    
    # Use combn() to get all combinations of nodes within the current cluster
    edges <- combn(nodes, 2) %>%
      t() %>%
      as.data.frame() %>%
      filter(V1 != V2) %>%
      distinct() %>%
      rename(source = V1, target = V2)
    
    # Add a column indicating the cluster ID for each edge
    edges$cluster_id <- cluster_id
    
    # Set the name of the edgelist
    edgelist_name <- paste(edgelist_prefix, cluster_id, sep = "_")
    
    # Store the edgelist in the list of edgelists
    edgelists[[edgelist_name]] <- edges
  }
  
  # Combine all edgelists into a single edgelist
  all_edges <- do.call(rbind, edgelists)
  
  return(all_edges)
}

```

## Apply the function:

```{r}
# Generate edgelists for ClusteredPhyloAny column
phylo_data <-
  individuals_dt[!is.na(individuals_dt$ClusteredPhyloAny),] 
#function needs for NA vals in ClusteredPhyloAny to be removed for it to run
phylo_edgelist <-
  create_edgelists(data = phylo_data,
                   cluster_col = "ClusteredPhyloAny",
                   edgelist_prefix = "phylo_edgelist")


# Generate edgelists for ClusteredHIVTrace005 column
hivtrace005_edgelist <-
  create_edgelists(data = individuals_dt,
                   cluster_col = "ClusteredHIVTrace005",
                   edgelist_prefix = "005_edgelist")

# Generate edgelists for ClusteredHIVTrace015 column
hivtrace015_edgelist <-
  create_edgelists(data = individuals_dt,
                   cluster_col = "ClusteredHIVTrace015",
                   edgelist_prefix = "015_edgelist")

```

## Tests 

* For Trace 005
```{r}
x <- as.numeric(table(individuals_dt$ClusteredHIVTrace005)[-1])
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(hivtrace005_edgelist))
```

* For Trace 015
```{r}
x <- as.numeric(table(individuals_dt$ClusteredHIVTrace015)[-1])
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(hivtrace015_edgelist))
```

* For ClusteredPhyloAny

```{r}
x <- as.numeric(table(individuals_dt$ClusteredPhyloAny))
y <- lapply(x, function (x) choose(x, 2))
sum(unlist(y)) #number of edges across all molecular clusters

(sum(unlist(y)) == nrow(phylo_edgelist))
```

# Regresssions

## Table "4A":
For now, let's use the HIV Trace 015 dataset. (Next round, I will add 
`phyloany` and `015`).

# Prepare data for regression analysis

How many index persons in the HIVTrace015 dataset?

```{r}
index_person_idx_in_015 <- which(individuals_dt$ClusteredHIVTrace015 != "")
index_persons_in_015 <- individuals_dt$StudyID[index_person_idx_in_015]
length(index_person_idx_in_015)

individuals_dt_w_index_persons_in_015 <- individuals_dt[index_person_idx_in_015,]
dim(individuals_dt_w_index_persons_in_015)
```

How many of these index persons are in the named partner list?

```{r}
named_pt_net%v% "vertex.names"
sequence015_persons_in_named_pt_net_idx <- which((index_persons_in_015) %in% (named_pt_net %v% "vertex.names"))

individuals_dt_w_index_persons_in_015$named_partner_indicator <- 0
individuals_dt_w_index_persons_in_015$named_partner_indicator[sequence015_persons_in_named_pt_net_idx] <- 1

individuals_dt_w_index_persons_in_015$named_partner_indicator <-
  as.factor(individuals_dt_w_index_persons_in_015$named_partner_indicator)

table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
```

Run the regression model:

```{r}

table(individuals_dt_w_index_persons_in_015$DemoGender, exclude = NULL)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(DemoGender, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
m1 <- glm(named_partner_indicator ~ DemoGender,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m1)

table(individuals_dt_w_index_persons_in_015$DemoRace)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(DemoRace, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
m2 <- glm(named_partner_indicator ~ DemoRace,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m2)

table(individuals_dt_w_index_persons_in_015$SequenceSubtype)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(SequenceSubtype, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
rowSums(xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(SequenceSubtype, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015))

# recode sequence
original_sequences <- individuals_dt_w_index_persons_in_015$SequenceSubtype
recoded_sequences <- ifelse(grepl("^B", original_sequences), "B", "non-B")
cbind(original_sequences, recoded_sequences)
individuals_dt_w_index_persons_in_015$recoded_sequence_subtype <- recoded_sequences

table(individuals_dt_w_index_persons_in_015$recoded_sequence_subtype)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(recoded_sequence_subtype, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
rowSums(xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(recoded_sequence_subtype, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015))

m3 <- glm(named_partner_indicator ~ recoded_sequence_subtype,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m3)

table(individuals_dt_w_index_persons_in_015$RiskMSM)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(RiskMSM, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
m4 <- glm(named_partner_indicator ~ RiskMSM,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m4)

table(individuals_dt_w_index_persons_in_015$RiskHRH)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(RiskHRH, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
m5 <- glm(named_partner_indicator ~ RiskHRH,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m5)

table(individuals_dt_w_index_persons_in_015$RiskIDU)
xtabs(~ factor(named_partner_indicator, exclude = NULL)+
      factor(RiskIDU, exclude = NULL),
      data = individuals_dt_w_index_persons_in_015)
m6 <- glm(named_partner_indicator ~ RiskIDU,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m6)

m7 <- glm(named_partner_indicator ~ HIVDxAge,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(m7)

summary(individuals_dt_w_index_persons_in_015$HIVDxAge)
tapply(individuals_dt_w_index_persons_in_015$HIVDxAge, 
       individuals_dt_w_index_persons_in_015$named_partner_indicator, 
       summary)
model <- glm(named_partner_indicator ~ DemoGender+DemoRace+SequenceSubtype,
  data = individuals_dt_w_index_persons_in_015,
  family = "binomial")
summary(model)
```

How many persons appear in the named partner dataset?

```{r}
length(unique(named_pt_net%v% "vertex.names"))
```

How many of these named persons are in 015 cluster sequence?

```{r}
named_pt_net%v% "vertex.names"
named_pts_in_015_clusters_idx <- which((named_pt_net %v% "vertex.names") %in% index_persons_in_015)
length(named_pts_in_015_clusters_idx)

individuals_dt_w_index_persons_in_015$named_partner_indicator <- 0
individuals_dt_w_index_persons_in_015$named_partner_indicator[sequence015_persons_in_named_pt_net_idx] <- 1

individuals_dt_w_index_persons_in_015$named_partner_indicator <-
  as.factor(individuals_dt_w_index_persons_in_015$named_partner_indicator)

table(individuals_dt_w_index_persons_in_015$named_partner_indicator, exclude = NULL)
```

