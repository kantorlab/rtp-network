---
title: "Vlad's questions: Number of partners (named or unnamed) reported longitudinally by index persons"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
```

## Introduction

Last time, we discussed the contact tracing dataset and my analysis thus far and questions on it. Vlad is interested in broadly knowing the factors of interest driving cluster growth: High VL, STI incidence, growing number of partners, etc.  To that end, we are interested in understanding if the 
changing number of partners over time can be measured, for instance, 
if we knew
the number of reported partners per person per year (named or unnamed) 
reported by the index cases (i.e., newly diagnosed persons). 

There are two other related questions:
  - If the recency of infection is [known]( https://docs.google.com/document/d/1j0uxP8P0DGefUEg8sr8ncT1GWIvz-6AOK42S8zcIans/edit#bookmark=id.yqp4tue4v2f).

  - A minor question about who we mean as ["Third Party"](https://docs.google.com/document/d/1j0uxP8P0DGefUEg8sr8ncT1GWIvz-6AOK42S8zcIans/edit#bookmark=id.un9xszbe7gwi) as the Notifier.
  
First, we will analyze the individuals dataset to try to answer this question.
Next, we will analyze the contact tracing network dataset.

## Individual Dataset
  
```{r}
data_dir <- "/gpfs/data/rkantor/rtp/datasets/D30_20211013_V1"
list.files(path=data_dir)
net_dt <- fread(paste0(data_dir, "/ContactTracingNetwork.csv"))
individuals_dt <- fread(paste0(data_dir, "/Individuals.csv"))

# dim(net_dt)
# str(net_dt)
# sort(colnames(net_dt))
View(net_dt)

dim(individuals_dt)
colnames(individuals_dt)
```
  
Source of Referral:

```{r}
individuals_dt[,.N, by="Source"][, 
  "prop" := round(N/sum(N), 3)][]
```
Race and Gender:

```{r}
individuals_dt[,.N, by=c("DemoGender", "DemoRace")][, 
  "prop" := round(N/sum(N), 3)][]
```
Birth Country:

```{r}
individuals_dt[,.N, by=c("DemoBirthCountry")][, 
  "prop" := round(N/sum(N), 3)][order(-prop)][]
```
Year of HIV diagnosis:

```{r}
dx_year_dt <- 
  individuals_dt[,.(
  "dx_year" = substr(HIVDxDate, 1, 4)
  ), 
  ][,.N, by="dx_year"][, 
  "prop" := round(N/sum(N), 3)][order(-prop)][]
dx_year_dt
```
Age of HIV diagnosis:

```{r}
summary(individuals_dt$HIVDxAge)
```

Last HIV-negative year:


```{r}
last_neg_year <- 
  individuals_dt[,.(
  "last_neg_year" = substr(HIVLastNegativeYear, 1, 4)
  ), 
  ][,.N, by="last_neg_year"][, 
  "prop" := round(N/sum(N), 3)][order(last_neg_year)][]
last_neg_year
```
Crosstabs by date of diagnosis and last negative test:

```{r}
xtabs(data = individuals_dt, 
      ~factor(substr(HIVDxDate, 1, 4), exclude = NULL) +
        factor(HIVLastNegativeYear, exclude = NULL))
```

By sequence present:

```{r}
table(individuals_dt$Sequence, exclude = NULL)
```

By sequence subtype:
```{r}
table(individuals_dt$SequenceSubtype, exclude = NULL)
```

Columns 34-43 in the individuals database might be of preliminary interest:

```{r}
table(individuals_dt$Outcome, exclude = NULL)
```
```{r}
table(individuals_dt$Outcome_Pri01_NamedAnyPartners, exclude = NULL)

```

Columns 34-43 look like they might be relevant, but they are all empty:

```{r}

apply(individuals_dt[,34:43], 2, function(x) table(x, exclude = NULL))
```

## Network Dataset

How many contacts are reported by each interviewed participant 
(i.e., "StudyIDFrom") at each interview?


```{r}
net_dt[,.N, by=c("StudyIDFrom")][order(-N)]
net_dt[,.N, by=c("StudyIDFrom", "ReferralDate")][order(-StudyIDFrom)]
net_dt[,.N, by=c("StudyIDFrom", "ReferralDate", "StudyIDTo")][order(-StudyIDFrom)]
```
```{r}
xtabs(data = net_dt, 
      ~ factor(substr(StudyIDFrom, 1, 6), exclude = NULL) +
  factor(substr(ReferralDate, 1, 4), exclude = NULL)
)
        
```
Using the referral date, how many contacts ("StudyIDTo") 
were reported by the indexes ("StudyIDFrom") in each year?

```{r}
contacts_reported_peryear_by_indices <- 
  dcast(net_dt[substr(StudyIDFrom, 1, 1) != "C"],
      StudyIDTo ~ substr(ReferralDate, 1, 4),
      value.var = "StudyIDFrom",
      fun.aggregate = length
      )[order(-StudyIDTo)]
```

Index persons reporting more than 1 partner (not necessarily in different years):

```{r}
num_ptns <- 
  apply(contacts_reported_peryear_by_indices[,-c(1:2)], 1, function(x)
  sum(x, na.rm = TRUE)
)

length(num_ptns) == nrow(contacts_reported_peryear_by_indices)
names(num_ptns) <- contacts_reported_peryear_by_indices$StudyIDTo
num_ptns <- num_ptns[-length(num_ptns)]
summary(num_ptns)

num_ptns[which(num_ptns > 1)]
```

