---
title: 'Vlad''s questions: Longitudinal partner data analysis'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
```

## Introduction

Vlad and I have discussed the contact tracing dataset and my analysis thus far 
and questions on it. He is interested in broadly knowing the factors of interest 
driving cluster growth: High VL, STI incidence, growing number of partners, etc.  
To that end, we are interested in understanding if the 
changing number of partners over time can be measured, for instance, 
if we knew the number of reported partners per person per year (named or unnamed) 
reported by the index cases (i.e., newly diagnosed persons). 

We analyzed two datasets: Contact Tracing Network and the Individuals Dataset. 

```{r}
data_dir <- "/gpfs/data/rkantor/rtp/datasets/D30_20211013_V1"
list.files(path=data_dir)
net_dt <- fread(paste0(data_dir, "/ContactTracingNetwork.csv"))
individuals_dt <- fread(paste0(data_dir, "/Individuals.csv"))

```
  
## Executive Summary and Data Dictionary
 The closest answers to question of assessment of reported partner numbers 
have come from the network data analysis. We present our analysis of the
networks dataset first, below. This allows us to consider the:  

 - Annual number of contacts reported by each index person (reported in our data folder as 
`contacts_reported_peryear_by_indices.csv`): This dataset lists the `StudyIDTo`
for each contact  and the years in which they were nominated by an index person.


- Number of index persons reporting contacts each year (`index_persons_reporting_contacts.csv`):
This dataset lists the `StudyIDFrom` for each index person and the number of 
contacts that they nominated each year.  

Both datasets are located at `/gpfs/data/rkantor/rtp/datasets/D41_20220915_unified/partners_data/`.

The Individuals Dataset might have some pertinent information, but the 
columns that would be relevant to answering our questions appear to be blank. 
An analysis of this dataset is provided towards the end of this document, 
though it does not provide much useful information.

The source code to reproduce this file is [here](https://github.com/kantorlab/rtp-network/blob/main/vlads-questions.Rmd).


## Network Dataset

We start by listing all the columns in the network dataset:

```{r}
colnames(net_dt)
```

### How many contacts are reported by each index person?

To answer this question, we consider the `StudyIDFrom` variable in the 
network dataset. 

Data Checks:
```{r}

class(net_dt)
is.data.table(net_dt) == TRUE
```


**Exploratory Analysis:**  

- Order the networks dataset in descending order of `StudyIDFrom`:   

```{r}
net_dt[,.N, by=c("StudyIDFrom")][order(-N)]
```

- Order the networks dataset in descending order of `StudyIDFrom`, `ReferralDate`,
and `StudyIDTo`:  

```{r}
net_dt[,.N, by=c("StudyIDFrom", "ReferralDate")][order(-StudyIDFrom)]
net_dt[,.N, by=c("StudyIDFrom", "ReferralDate", "StudyIDTo")][order(-StudyIDFrom)]
```

- Repeat the above step with Referral Date denoted in YYYY format:

```{r}
RD_YYYY <- substr(net_dt$ReferralDate, 1, 4)
net_dt[, `:=` (RD_YYYY = RD_YYYY)]
head(net_dt)

net_dt[,.N, by=c("StudyIDFrom", "RD_YYYY", "StudyIDTo")][order(-StudyIDFrom)]
```


The dataset `contacts_reported_peryear_by_indices` below shows
the number of index persons that nominate a given
contact in a year. (The zeros do niot differentiate between "no one reported" and 
"contact not in the database".) 

```{r}
contacts_reported_peryear_by_indices <- 
  dcast(net_dt[substr(StudyIDFrom, 1, 1) != "C"],
      StudyIDTo ~ substr(ReferralDate, 1, 4),
      value.var = "StudyIDFrom",
      fun.aggregate = length
      )[order(-StudyIDTo)]

contacts_reported_peryear_by_indices <- 
  contacts_reported_peryear_by_indices[-nrow(contacts_reported_peryear_by_indices),]

head(contacts_reported_peryear_by_indices)
```



Contacts (i.e. `StudyIDTo`) reported by more than 1 index person 
(in  same or in different years):

```{r}
num_ptns <- 
  apply(contacts_reported_peryear_by_indices[,-c(1:2)], 1, function(x)
  sum(x, na.rm = TRUE)
)


#num_ptns
#num_ptns[which(num_ptns > 1)]
```


Contacts (i.e. `StudyIDTo`)  reported by at least one index person in multiple 
years: 

```{r}
num_ptns_agg_by_nonzero <- 
  apply(contacts_reported_peryear_by_indices[,-c(1:2)], 1, function(x)
  length(which(x > 0))
)

#num_ptns_agg_by_nonzero


# length(num_ptns) == nrow(contacts_reported_peryear_by_indices)
# names(num_ptns) <- contacts_reported_peryear_by_indices$StudyIDTo
# num_ptns <- num_ptns[-length(num_ptns)]
# summary(num_ptns)
# 
# num_ptns
# num_ptns[which(num_ptns > 1)]
```

Data check: The vectors `num_ptns` and `num_ptns_agg_by_nonzero` are not identical:

```{r}
identical(num_ptns, num_ptns_agg_by_nonzero)
```

Data check: Interrogate the `num_ptns` and `num_ptns_agg_by_nonzero` objects further:

```{r}
class(num_ptns); head(num_ptns); head(names(num_ptns)); length(num_ptns)
class(num_ptns_agg_by_nonzero); head(num_ptns_agg_by_nonzero); head(names(num_ptns_agg_by_nonzero)); length(num_ptns_agg_by_nonzero)
```


Compare the nums of index persons who report a given contact 
(take `r contacts_reported_peryear_by_indices[1,]$StudyIDTo`) as an example:

```{r}
contacts_reported_peryear_by_indices[1,]
```

We see that `r contacts_reported_peryear_by_indices[1,]$StudyIDTo` was reported by
index persons in 2019 and 2020. Thus, we would expect `num_ptns[1]` and 
`num_ptns_agg_by_nonzero[1]`
to be identical.

```{r}
identical(num_ptns[1], num_ptns_agg_by_nonzero[1])

num_ptns[1]
num_ptns_agg_by_nonzero[1]
```

Let us now identify the positions where `num_ptns` and `num_ptns_agg_by_nonzero`
are not the same. The number of index persons reporting these contacts 
(`StudyIDTo`)  as partners in a given year are not the same as the 
number of years in which these contacts are reported as a partners, 
i.e., multiple index persons report these 
Study IDs as partners in at least one year.

```{r}
which(num_ptns != num_ptns_agg_by_nonzero)
contacts_reported_peryear_by_indices[13,]
```

We confirm above that contact 
`r contacts_reported_peryear_by_indices[13,]$StudyIDTo` 
is reported three times, all of which are in the same year. 

Further, we see below that the `num_ptns` (showing the number of index persons
who nominated this contact) as 3, and the  
`num_ptns_agg_by_nonzero`, i.e., the number of aggregate nominations of this contact by year,
as being 1. 

```{r}
num_ptns[13]
num_ptns_agg_by_nonzero[13]
```

Below we show the index persons that report `r contacts_reported_peryear_by_indices[13,]$StudyIDTo` 
as contact:

```{r}
x <- which(net_dt$StudyIDTo == contacts_reported_peryear_by_indices[13,]$StudyIDTo)
net_dt[x,]
```
Per our definition, three index persons (`StudyIDFrom` not starting with "CONTACT") 
report `r contacts_reported_peryear_by_indices[13,]$StudyIDTo` as contact.

Save this dataset:

```{r}
fwrite(contacts_reported_peryear_by_indices, 
       "/gpfs/data/rkantor/rtp/datasets/D41_20220915_unified/partners_data/contacts_reported_peryear_by_indices.csv")
```

### How many index persons are reporting contacts each year?

Below we compile data on the number of index persons reporting contacts each year:

```{r}
index_persons_reporting_contacts <- 
  dcast(net_dt[substr(StudyIDTo, 1, 1) != ""],
      StudyIDFrom ~ substr(ReferralDate, 1, 4),
      value.var = "StudyIDTo",
      fun.aggregate = length
      )[order(-StudyIDFrom)]



head(index_persons_reporting_contacts)
#index_persons_reporting_contacts[nrow(index_persons_reporting_contacts)]
```

Save this dataset:

```{r}
fwrite(index_persons_reporting_contacts, 
       "/gpfs/data/rkantor/rtp/datasets/D41_20220915_unified/partners_data/index_persons_reporting_contacts.csv")
```



## Individual Dataset
  

  
Source of Referral:

```{r}
individuals_dt[,.N, by="Source"][, 
  "prop" := round(N/sum(N), 3)][]
```
Race and Gender:

```{r}
individuals_dt[,.N, by=c("DemoGender", "DemoRace")][, 
  "prop" := round(N/sum(N), 3)][]
```
Birth Country:

```{r}
individuals_dt[,.N, by=c("DemoBirthCountry")][, 
  "prop" := round(N/sum(N), 3)][order(-prop)][]
```
Year of HIV diagnosis:

```{r}
dx_year_dt <- 
  individuals_dt[,.(
  "dx_year" = substr(HIVDxDate, 1, 4)
  ), 
  ][,.N, by="dx_year"][, 
  "prop" := round(N/sum(N), 3)][order(-prop)][]
dx_year_dt
```
Age of HIV diagnosis:

```{r}
summary(individuals_dt$HIVDxAge)
```

Last HIV-negative year:


```{r}
last_neg_year <- 
  individuals_dt[,.(
  "last_neg_year" = substr(HIVLastNegativeYear, 1, 4)
  ), 
  ][,.N, by="last_neg_year"][, 
  "prop" := round(N/sum(N), 3)][order(last_neg_year)][]
last_neg_year
```
Crosstabs by date of diagnosis and last negative test:

```{r}
xtabs(data = individuals_dt, 
      ~factor(substr(HIVDxDate, 1, 4), exclude = NULL) +
        factor(HIVLastNegativeYear, exclude = NULL))
```

By presence of sequence:

```{r}
table(individuals_dt$Sequence, exclude = NULL)
```

By sequence subtype:
```{r}
table(individuals_dt$SequenceSubtype, exclude = NULL)
```

Columns 34-43 in the individuals database might be of preliminary interest:

```{r}
table(individuals_dt$Outcome, exclude = NULL)
```
```{r}
table(individuals_dt$Outcome_Pri01_NamedAnyPartners, exclude = NULL)

```

Columns 34-43 look like they might be relevant, but they are all empty:

```{r}

apply(individuals_dt[,34:43], 2, function(x) table(x, exclude = NULL))
```




## Other questions/Next Steps 

- Use `0` to indicate no partners reported and `NA` to denote the period before
the index person was referred. 

- Assess mutuality, i.e., cross-naming - i.e., person who is nominated by someone also
nominates them?

There are two other related questions that came up in the discussion with Vlad:  

  - If the recency of infection is [known]( https://docs.google.com/document/d/1j0uxP8P0DGefUEg8sr8ncT1GWIvz-6AOK42S8zcIans/edit#bookmark=id.yqp4tue4v2f).

  - A minor question about who we mean as ["Third Party"](https://docs.google.com/document/d/1j0uxP8P0DGefUEg8sr8ncT1GWIvz-6AOK42S8zcIans/edit#bookmark=id.un9xszbe7gwi) as the Notifier.
  
I am waiting on Mark to hear back about both of the latter two questions (among other things). 
  
